function [A, B, Q, R] = make_suspension_lti(n, m, Ts)
% make_suspension_lti - 車両サスペンションシステムを生成
%
% 入力:
%   n: 状態次元（4を推奨、6に拡張可能）
%   m: 入力次元（1に固定）
%   Ts: サンプリング時間（秒、デフォルト: 0.01）
%
% 出力:
%   A: 離散時間システム行列
%   B: 入力行列
%   Q: 状態重み行列（乗り心地と操縦安定性に重み）
%   R: 入力重み行列

if nargin < 3 || isempty(Ts)
    Ts = 0.01;  % デフォルトサンプリング時間（サスペンションは速いダイナミクス）
end

% 連続時間モデル: 1/4車両モデル（クォーターモデル）
% 状態: [車体位置; 車体速度; ホイール位置; ホイール速度]
% 入力: アクチュエータ力

% サスペンションパラメータ（標準的な値）
ms = 300;      % 車体質量 [kg]
mu = 40;       % ホイール質量 [kg]
ks = 18000;    % サスペンションばね定数 [N/m]
kt = 200000;   % タイヤばね定数 [N/m]
bs = 1000;     % サスペンションダンパ係数 [N·s/m]

if n == 4
    % 4次システム: [車体位置; 車体速度; ホイール位置; ホイール速度]
    % 連続時間モデル
    Ac = [0, 1, 0, 0;
        -ks/ms, -bs/ms, ks/ms, bs/ms;
        0, 0, 0, 1;
        ks/mu, bs/mu, -(ks+kt)/mu, -bs/mu];
    
    if m == 1
        Bc = [0; 1/ms; 0; -1/mu];
        Q = diag([1, 0.1, 0.01, 0.01]);
        R_weight = 1;
    elseif m == 2
        % 前後アクチュエータ（簡略化: 同じ効果）
        Bc = [0, 0; 1/ms, 1/ms; 0, 0; -1/mu, -1/mu];
        Q = diag([1, 0.1, 0.01, 0.01]);
        R_weight = 1;
    else
        error('サスペンションシステムはm=1またはm=2のみ対応しています');
    end
    
elseif n == 6
    % 6次システム: 1/2車両モデル（前後サスペンション）
    % 状態: [前車体位置; 前車体速度; 前ホイール位置; 前ホイール速度; 後車体位置; 後車体速度]
    
    % 前後で同じパラメータを使用（簡略化）
    Ac = [0, 1, 0, 0, 0, 0;
        -ks/ms, -bs/ms, ks/ms, bs/ms, 0, 0;
        0, 0, 0, 1, 0, 0;
        ks/mu, bs/mu, -(ks+kt)/mu, -bs/mu, 0, 0;
        0, 0, 0, 0, 0, 1;
        0, 0, 0, 0, -ks/ms, -bs/ms];
    
    if m == 1
        Bc = [0; 1/ms; 0; -1/mu; 0; 0];  % 前アクチュエータのみ
        Q = diag([1, 0.1, 0.01, 0.01, 0.5, 0.05]);
        R_weight = 1;
    elseif m == 2
        % 前後アクチュエータ
        Bc = [0, 0; 1/ms, 0; 0, 0; -1/mu, 0; 0, 0; 0, 1/ms];
        Q = diag([1, 0.1, 0.01, 0.01, 1, 0.1]);
        R_weight = 1;
    else
        error('サスペンションシステムはm=1またはm=2のみ対応しています');
    end
    
else
    error('サスペンションシステムはn=4またはn=6のみ対応しています');
end

% 離散化（ゼロ次ホールド）
sys_c = ss(Ac, Bc, eye(n), zeros(n, m));
sys_d = c2d(sys_c, Ts, 'zoh');
A = sys_d.A;
B = sys_d.B;

% 数値的安定性の確認
rho_A = max(abs(eig(A)));
if rho_A >= 1.0
    warning('離散化後のシステムが不安定です（rho=%.4f）。Tsを小さくしてください。', rho_A);
end

% 制御可能性の確認
Ctrb = ctrb(A, B);
if rank(Ctrb) < n
    warning('システムが制御不可能です');
end

% 重み行列
Q = Q;
R = R_weight * eye(m);

end

